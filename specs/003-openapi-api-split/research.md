# Research: OpenAPI Support (Internal/External API Split)

**Date**: 2026-02-19
**Feature**: [spec.md](spec.md) | [plan.md](plan.md)

## Decision 1: OpenAPI Generation Approach

**Decision**: Use `rspec-openapi` gem (test-driven, auto-generation from existing RSpec request specs)

**Rationale**:
- The api-server already has comprehensive RSpec request specs for all 15 endpoints (10 external, 5 internal)
- `rspec-openapi` generates OpenAPI schemas by observing actual HTTP requests/responses during test execution — zero additional DSL required
- Aligns with Constitution Principle V (Simplicity): leverages existing tests, no new test patterns to learn
- Aligns with Constitution Principle IV (Test-First): tests ARE the source of truth for API contracts

**Alternatives considered**:

| Alternative | Pros | Cons | Why rejected |
|-------------|------|------|-------------|
| rswag | Most popular, fine-grained schema control, built-in Swagger UI | Requires rewriting all request specs in rswag DSL; heavy for our needs; Swagger UI not needed | Too much churn on existing specs for a documentation-only feature |
| committee | Schema-first validation (design-first) | Requires hand-writing OpenAPI YAML first, then validating against it | Opposite of our goal (we want to generate, not hand-write) |
| Hand-written YAML | Full control | Manual maintenance, drift risk, no test sync | Violates FR-009 (auto-sync with source code) |

## Decision 2: Internal/External File Separation

**Decision**: Use `rspec-openapi`'s lambda-based `path` configuration to route specs to separate files based on RSpec file path

**Rationale**:
- `RSpec::OpenAPI.path` accepts a lambda that receives the RSpec example, allowing file-path-based routing
- Existing spec directory structure already mirrors the API split: `spec/requests/api/v1/` and `spec/requests/internal/`
- Configuration is ~10 lines in a single file

**Configuration approach**:
```ruby
RSpec::OpenAPI.path = ->(example) {
  case example.file_path
  when %r{spec/requests/internal/}
    "doc/openapi/internal.yaml"
  else
    "doc/openapi/external.yaml"
  end
}
```

## Decision 3: OpenAPI File Format

**Decision**: YAML format

**Rationale**:
- YAML is the de facto standard for OpenAPI files in repositories (more readable, supports comments)
- `rspec-openapi` defaults to YAML output
- VSCode OpenAPI preview extensions (e.g., Swagger Viewer, OpenAPI Editor) support YAML natively
- JSON can be generated from YAML if needed downstream

**Alternatives considered**:
- JSON: Less readable, no comments, but valid. Can be generated from YAML if needed later.

## Decision 4: File Location

**Decision**: `api-server/doc/openapi/external.yaml` and `api-server/doc/openapi/internal.yaml`

**Rationale**:
- `doc/` is Rails convention for generated documentation
- `openapi/` subdirectory keeps the two files organized
- Files are version-controlled (committed to repo) per FR-008

## Decision 5: Generation Workflow

**Decision**: OpenAPI files are regenerated by running `OPENAPI=1 bundle exec rspec` (environment variable toggle)

**Rationale**:
- `rspec-openapi` uses an environment variable to enable/disable generation (avoids overhead on normal test runs)
- Developers regenerate when API changes are made, then commit the updated YAML files
- No CI/CD integration needed (out of scope per spec)

**Workflow**:
1. Developer modifies API endpoint or adds new one
2. Developer writes/updates corresponding RSpec request spec
3. Developer runs `OPENAPI=1 bundle exec rspec`
4. Updated YAML files appear in `doc/openapi/`
5. Developer commits the changes (code + updated YAML)

## Decision 6: Authentication Scheme Documentation

**Decision**: Configure `rspec-openapi`'s `security_schemes` for both JWT Bearer (external) and API Key (internal)

**Rationale**:
- FR-006 requires JWT Bearer Token documentation for external API
- FR-007 requires API Key header documentation for internal API
- `rspec-openapi` supports `RSpec::OpenAPI.security_schemes` configuration

## Decision 7: Response Example Generation

**Decision**: Let `rspec-openapi` capture actual response bodies from tests as examples

**Rationale**:
- Existing tests already exercise all success/error paths
- Actual response data from tests is more accurate than hand-crafted examples
- Alba serializers ensure consistent response structure

## Sources

- [rspec-openapi GitHub](https://github.com/exoego/rspec-openapi) — gem documentation and configuration reference
- [rswag GitHub](https://github.com/rswag/rswag) — alternative considered
- [Evil Martians: Let there be docs!](https://evilmartians.com/chronicles/let-there-be-docs-generating-openapi-schema-across-rails-stack) — Rails OpenAPI generation overview
- [Bump.sh: OpenAPI docs for Rails with RSwag](https://docs.bump.sh/guides/openapi/code-first-rails/) — rswag guide
